name: Docker Build and Test

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  docker-build-test:
    name: Build and Test Docker Image
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract platform name for tagging
        id: platform
        run: |
          PLATFORM_PAIR=${{ matrix.platform }}
          PLATFORM_NAME=${PLATFORM_PAIR//\//-}
          echo "name=${PLATFORM_NAME}" >> $GITHUB_OUTPUT
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ matrix.platform }}
          tags: longport-mcp:test-${{ steps.platform.outputs.name }}
          load: ${{ matrix.platform == 'linux/amd64' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test longport-mcp --help (AMD64 only)
        if: matrix.platform == 'linux/amd64'
        run: |
          echo "Testing longport-mcp --help command..."
          docker run --rm \
            -e LONGPORT_APP_KEY=test_key \
            -e LONGPORT_APP_SECRET=test_secret \
            -e LONGPORT_ACCESS_TOKEN=test_token \
            longport-mcp:test-linux-amd64 longport-mcp --help || echo "Help command requires env vars"
      
      - name: Test longport-mcp --version (AMD64 only)
        if: matrix.platform == 'linux/amd64'
        run: |
          echo "Testing longport-mcp --version command..."
          docker run --rm \
            -e LONGPORT_APP_KEY=test_key \
            -e LONGPORT_APP_SECRET=test_secret \
            -e LONGPORT_ACCESS_TOKEN=test_token \
            longport-mcp:test-linux-amd64 longport-mcp --version || echo "Version command not supported"
      
      - name: Verify entrypoint script (AMD64 only)
        if: matrix.platform == 'linux/amd64'
        run: |
          echo "Verifying entrypoint script exists and is executable..."
          docker run --rm --entrypoint ls longport-mcp:test-linux-amd64 -la /usr/local/bin/entrypoint.sh
          docker run --rm --entrypoint cat longport-mcp:test-linux-amd64 /usr/local/bin/entrypoint.sh
          echo "Verifying longport-mcp binary..."
          docker run --rm --entrypoint ls longport-mcp:test-linux-amd64 -la /usr/local/bin/longport-mcp
      
      - name: Test container startup with minimal env (AMD64 only)
        if: matrix.platform == 'linux/amd64'
        run: |
          echo "Testing container startup..."
          # Start container in background
          docker run -d \
            --name test-container \
            -e LONGPORT_APP_KEY=test_key \
            -e LONGPORT_APP_SECRET=test_secret \
            -e LONGPORT_ACCESS_TOKEN=test_token \
            -e LONGPORT_READONLY=true \
            longport-mcp:test-linux-amd64
          
          # Wait a few seconds for startup
          sleep 5
          
          # Check if container is running
          docker ps -a
          
          # Get container logs
          echo "Container logs:"
          docker logs test-container || true
          
          # Check if port is listening (may fail if credentials are invalid, but process should start)
          docker exec test-container netstat -tuln | grep 8000 || echo "Port 8000 not yet listening (expected with test credentials)"
          
          # Cleanup
          docker stop test-container || true
          docker rm test-container || true
      
      - name: Image size check (AMD64 only)
        if: matrix.platform == 'linux/amd64'
        run: |
          echo "Checking image size..."
          docker images longport-mcp:test-linux-amd64
          SIZE=$(docker images longport-mcp:test-linux-amd64 --format "{{.Size}}")
          echo "Image size: $SIZE"

  docker-compose-test:
    name: Test Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          LONGPORT_APP_KEY=test_app_key
          LONGPORT_APP_SECRET=test_app_secret
          LONGPORT_ACCESS_TOKEN=test_access_token
          LONGPORT_READONLY=true
          SERVER_PORT=8000
          EOF
      
      - name: Validate docker-compose.yml
        run: |
          docker compose config
      
      - name: Build with docker-compose
        run: |
          docker compose build
      
      - name: Check built image
        run: |
          docker images | grep longport-mcp
      
      - name: Start services with docker-compose
        run: |
          docker compose up -d
          sleep 10
      
      - name: Check service status
        run: |
          docker compose ps
          docker compose logs
      
      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          tags: longport-mcp:scan
          load: true
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: longport-mcp:scan
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
